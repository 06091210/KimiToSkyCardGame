<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ランダムカードドロー</title>
  <style>
  .card {
    all: unset;
    width: 100px;
    margin: 10px;
    cursor: grab;
    display: inline-block;
    position: absolute;  /* これを追加 */
    user-select: none;
  }
  .card img {
    width: 100%;
    height: auto;
    border-radius: 0;
    pointer-events: none;
  }
  #drawnCardsContainer {
    position: relative;
    height: 300px; /* 十分な高さを確保 */
    border: 1px solid #ccc;
  }
</style>

<div id="drawnCardsContainer" style="margin-top:10px; position: relative; height: 300px; border: 1px solid #ccc;"></div>

</head>
<body>

<h2>デッキコードから復元してランダムにカードを引く</h2>

<textarea id="deckCode" rows="2" cols="50" placeholder="例: 1x2,2x3"></textarea><br>
<button id="loadDeckBtn" onclick="loadDeckFromCode()">デッキを復元</button>

<div id="drawnCardArea" style="display: none;">
  <!-- brank 画像や引いたカードが表示される -->
</div>

<script>
  const cards = [
    { id: 1, name: "スカイ", image: "images/sky.jpg", maxCopies: 5 },
    { id: 2, name: "スカイ(ゆるキャラ)", image: "images/skyyurukyara.jpg", maxCopies: 5 },
    { id: 3, name: "スカイのヘッドホン", image: "images/skynoheddohon.jpg", maxCopies: 5 }
  ];

  const deck = [];
  const drawnCards = [];  // 引いたカードを保持（必要に応じて）

  function createCardElement(card) {
    const div = document.createElement('div');
    div.className = 'card';
    div.draggable = true; // ドラッグ可能にする
    div.title = card.name;

    const img = document.createElement('img');
    img.src = card.image;
    img.alt = card.name;
    div.appendChild(img);

    // ドラッグ開始イベントでカード情報をtransferDataにセット
    div.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', JSON.stringify(card));
      // カーソルに画像を表示させたい場合はここで設定も可能
    });

    return div;
  }

  function loadDeckFromCode() {
    const code = document.getElementById('deckCode').value.trim();
    if (!code) return;

    const newDeck = [];
    const entries = code.split(',');

    for (const entry of entries) {
      const [idStr, countStr] = entry.split('x');
      const id = parseInt(idStr);
      const count = parseInt(countStr);

      const card = cards.find(c => c.id === id);
      if (!card || isNaN(count) || count <= 0 || count > card.maxCopies) {
        alert(`無効なカードIDや枚数です: ${entry}`);
        return;
      }

      for (let i = 0; i < count; i++) {
        newDeck.push(card);
      }
    }

    if (newDeck.length > 50) {
      alert("デッキは50枚までです！");
      return;
    }

    deck.length = 0;
    newDeck.forEach(card => deck.push(card));

    // 非表示処理
    document.getElementById('deckCode').style.display = 'none';
    document.getElementById('loadDeckBtn').style.display = 'none';

    // drawnCardAreaを表示し、brank画像を常に表示
    const drawnArea = document.getElementById('drawnCardArea');
    drawnArea.style.display = 'block';

    drawnArea.innerHTML = `
      <img id="brankImage" src="images/brank.jpeg" alt="カードを引く" />
      <div id="drawnCardsContainer" style="margin-top:10px;"></div>
    `;

    // brank画像クリックでカードを引く
    document.getElementById('brankImage').addEventListener('click', drawRandomCard);
  }

function makeDraggable(el) {
  let offsetX, offsetY;
  let isDragging = false;

  el.style.position = 'absolute';

  el.addEventListener('mousedown', (e) => {
    isDragging = true;
    // マウスと要素のずれを計算
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;

    el.style.cursor = 'grabbing';

    // 最前面に持ってくるためz-index上げる
    el.style.zIndex = 1000;

    // イベントのデフォルト動作キャンセル（画像ドラッグ防止など）
    e.preventDefault();
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    // 新しい位置を設定
    el.style.left = (e.clientX - offsetX) + 'px';
    el.style.top = (e.clientY - offsetY) + 'px';
  });

  document.addEventListener('mouseup', () => {
    if (!isDragging) return;
    isDragging = false;
    el.style.cursor = 'grab';
    el.style.zIndex = ''; // 元に戻す
  });
}

// drawRandomCard() 内の最後に下記を呼び出す
function drawRandomCard() {
  if (deck.length === 0) {
    alert("デッキにもうカードがありません！");
    return;
  }

  const randomIndex = Math.floor(Math.random() * deck.length);
  const drawnCard = deck.splice(randomIndex, 1)[0];
  drawnCards.push(drawnCard);

  const container = document.getElementById('drawnCardsContainer');
  const cardElement = createCardElement(drawnCard);

  // 初期位置はcontainerの左上あたりに設定
  cardElement.style.left = '10px';
  cardElement.style.top = '10px';

  container.appendChild(cardElement);

  makeDraggable(cardElement);
}

</script>

</body>
</html>
