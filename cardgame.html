<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ランダムカードドロー（ドラッグ移動対応）</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }

    #drawnCardArea {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #brankImage {
      width: 100px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .movable {
      position: absolute;
      width: 100px;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
  </style>
</head>
<body>

<h2>デッキコードから復元してランダムにカードを引く(改2)</h2>
<textarea id="deckCode" rows="2" cols="50" placeholder="例: 1x2,2x3"></textarea><br>
<button id="loadDeckBtn" onclick="loadDeckFromCode()">デッキを復元</button>

<div id="drawnCardArea" style="display: none;">
  <img id="brankImage" src="images/brank.jpeg" alt="カードを引く">
</div>

<script>
  const cards = [
    { id: 1, name: "スカイ", image: "images/sky.jpg", maxCopies: 5 },
    { id: 2, name: "スカイ(ゆるキャラ)", image: "images/skyyurukyara.jpg", maxCopies: 5 },
    { id: 3, name: "スカイのヘッドホン", image: "images/skynoheddohon.jpg", maxCopies: 5 }
  ];

  const deck = [];

  function createCardElement(card) {
    const img = document.createElement('img');
    img.src = card.image;
    img.alt = card.name;
    img.className = 'movable';
    img.style.top = '200px';
    img.style.left = '100px';

    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    // マウス操作
    img.addEventListener('mousedown', (e) => {
      isDragging = true;
      const rect = img.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      img.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      moveImage(e.clientX, e.clientY);
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      img.style.cursor = 'grab';
    });

    // タッチ操作
    img.addEventListener('touchstart', (e) => {
      isDragging = true;
      const rect = img.getBoundingClientRect();
      const touch = e.touches[0];
      offsetX = touch.clientX - rect.left;
      offsetY = touch.clientY - rect.top;
      e.preventDefault();
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const touch = e.touches[0];
      moveImage(touch.clientX, touch.clientY);
    });

    document.addEventListener('touchend', () => {
      isDragging = false;
    });

    document.addEventListener('touchcancel', () => {
      isDragging = false;
    });

    function moveImage(clientX, clientY) {
      const x = clientX - offsetX;
      const y = clientY - offsetY;
      img.style.left = x + 'px';
      img.style.top = y + 'px';
    }

    return img;
  }

  function loadDeckFromCode() {
  const code = document.getElementById('deckCode').value.trim();
  if (!code) return;

  // デッキ作成処理（省略）

  deck.length = 0;
  newDeck.forEach(card => deck.push(card));

  // UI切替
  document.getElementById('deckCode').style.display = 'none';
  document.getElementById('loadDeckBtn').style.display = 'none';
  const drawnCardArea = document.getElementById('drawnCardArea');
  drawnCardArea.style.display = 'flex';

  // クリックイベントをこのタイミングで設定（重複防止）
  const brankImage = document.getElementById('brankImage');
  brankImage.addEventListener('click', drawRandomCard);
}

function drawRandomCard() {
  if (deck.length === 0) {
    alert("デッキにもうカードがありません！");
    return;
  }

  const randomIndex = Math.floor(Math.random() * deck.length);
  const drawnCard = deck.splice(randomIndex, 1)[0];

  const brankImg = document.getElementById('brankImage');
  const rect = brankImg.getBoundingClientRect();

  const cardElement = createCardElement(drawnCard);

  // ブラウザによってはスクロール位置を考慮しないとズレる
  const scrollX = window.scrollX || window.pageXOffset;
  const scrollY = window.scrollY || window.pageYOffset;

  cardElement.style.left = (rect.left + scrollX) + 'px';
  cardElement.style.top = (rect.top + scrollY) + 'px';

  cardElement.style.position = 'absolute';

  document.body.appendChild(cardElement);
  /*}*/

    const randomIndex = Math.floor(Math.random() * deck.length);
    const drawnCard = deck.splice(randomIndex, 1)[0];

    const cardElement = createCardElement(drawnCard);
    document.body.appendChild(cardElement); // body に追加することで自由に動かせる
  }
</script>

</body>
</html>
