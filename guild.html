<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ギルド一覧</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f0f7ff;
  margin: 0;
  padding: 20px;
  text-align: center;
}
h1 { color: #2a4d8f; }
h2 { color: #3a5ca9; margin-top: 30px; }
.guild-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  padding: 12px 15px;
  margin: 10px auto;
  max-width: 350px;
  text-align: left;
}
.guild-card button {
  background: #2a4d8f;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}
.guild-card button:disabled {
  background: gray;
  cursor: default;
}
</style>
</head>
<body>

<h1>🏰 ギルド一覧</h1>

<input type="hidden" id="username" placeholder="例：スカイ" oninput="login()">
<button onclick="login()">ログイン</button>

<h2>🟢 未完了ギルド</h2>
<div id="guilds-incomplete"></div>

<h2>🟣 完了ギルド</h2>
<div id="guilds-complete"></div>

<script>
let user = "";
const GAS_URL = "https://script.google.com/macros/s/AKfycbw-xZ8j0y4K_lBfXMIn-m-kfZe1JHPUqCkobkm1bY6TUhY5ZHsDL4SQEEJRvL4TtG9z/exec"; // ←あなたのGAS URLに置き換える

function login() {
  user = document.getElementById("username").value.trim();
  if(!user) return alert("名前を入力してください。");
  loadGuilds();
}

async function loadGuilds() {
  if(!user) return;

  // 共通ギルド
  const res1 = await fetch(`${GAS_URL}?action=getGuilds`);
  const guilds = await res1.json();

  // 個別ギルド
  const res2 = await fetch(`${GAS_URL}?action=getPersonalGuilds&user=${encodeURIComponent(user)}`);
  const personal = await res2.json();

  displayGuilds([...guilds, ...personal]);
}

function displayGuilds(allGuilds) {
  const incompleteDiv = document.getElementById("guilds-incomplete");
  const completeDiv = document.getElementById("guilds-complete");
  incompleteDiv.innerHTML = "";
  completeDiv.innerHTML = "";

  allGuilds.forEach(g => {
    // g: [id, user?, name, description, point, type]
    let id = g[0];
    let name = g[2];
    let desc = g[3];
    let point = g[4];
    let type = g[5];

    const completedCount = Number(localStorage.getItem(`${user}_${id}`) || 0);
    const isComplete = (type === "once" && completedCount > 0);

    const div = document.createElement("div");
    div.className = "guild-card";
    div.innerHTML = `
      <h3>${name}</h3>
      <p>${desc}</p>
      <p>タイプ: ${type === "once" ? "一人一回まで" : "何回でもOK"}</p>
      ${type === "repeat" ? `<p>完了回数: ${completedCount}</p>` : ""}
      <button ${isComplete ? "disabled" : ""}>＋ ギルド完了</button>
    `;
    const button = div.querySelector("button");
    button.addEventListener("click", async () => {
      await fetch(`${GAS_URL}?action=complete&user=${encodeURIComponent(user)}&guildId=${id}`);
      localStorage.setItem(`${user}_${id}`, completedCount+1);
      loadGuilds();
    });

    (isComplete ? completeDiv : incompleteDiv).appendChild(div);
  });
}
  const nameInput = document.getElementById("username")
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        loadMessage();
      }
    });
</script>

</body>
</html>
