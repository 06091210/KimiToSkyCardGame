<!--<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚®ãƒ«ãƒ‰</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #eef5ff;
  margin: 0;
  padding: 20px;
  text-align: center;
}
h1 { color: #284d9e; }
h2 { color: #4a5dbb; margin-top: 25px; }
.guild-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  padding: 12px 15px;
  margin: 10px auto;
  max-width: 350px;
  text-align: left;
}
.guild-card button {
  background: #284d9e;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}
.guild-card button:disabled {
  background: gray;
  cursor: default;
}
</style>
</head>
<body>

<h1> </h1>

<input type="hidden" id="username" placeholder="ä¾‹ï¼šã‚¹ã‚«ã‚¤">
<!--<button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>

<h2>ğŸŸ¢ æœªå®Œäº†ã‚®ãƒ«ãƒ‰</h2>
<div id="guilds-incomplete"></div>

<h2>ğŸŸ£ å®Œäº†ã‚®ãƒ«ãƒ‰</h2>
<div id="guilds-complete"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz8axpmacW0-JGZ0RnCiELFoD3bIXn5xRwPpc-rEbPAtQNKtD7-W22-rWNnrRKK0qjb/exec"; // â†ã‚ãªãŸã®GAS URLã«å¤‰æ›´
let user = "";
let completedMap = {};

async function login() {
  user = document.getElementById("username").value.trim();
  if (!user) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  loadGuilds();
}

async function loadGuilds() {
  const [guilds, personals, completed] = await Promise.all([
    fetch(`${GAS_URL}?action=getGuilds`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getPersonalGuilds&user=${encodeURIComponent(user)}`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getCompleted&user=${encodeURIComponent(user)}`).then(r=>r.json())
  ]);

  completedMap = {};
  completed.forEach(c => completedMap[c[1]] = Number(c[2]));

  displayGuilds([...guilds, ...personals]);
}

function displayGuilds(allGuilds) {
  const incompleteDiv = document.getElementById("guilds-incomplete");
  const completeDiv = document.getElementById("guilds-complete");
  incompleteDiv.innerHTML = "";
  completeDiv.innerHTML = "";

  allGuilds.forEach(g => {
    const [id, , name, desc, point, type] = g;
    const count = completedMap[id] || 0;
    const isComplete = (type === "once" && count > 0);

    const div = document.createElement("div");
    div.className = "guild-card";
    div.innerHTML = `
      <h3>${name}</h3>
      <p>${desc}</p>
      <p>ãƒã‚¤ãƒ³ãƒˆ: ${point} / ã‚¿ã‚¤ãƒ—: ${type === "once" ? "ä¸€äººä¸€å›ã¾ã§" : "ä½•å›ã§ã‚‚OK"}</p>
      ${type === "repeat" ? `<p>å®Œäº†å›æ•°: ${count}</p>` : ""}
      <button ${isComplete ? "disabled" : ""}>ï¼‹ ã‚®ãƒ«ãƒ‰å®Œäº†</button>
    `;

    div.querySelector("button").addEventListener("click", async () => {
      const res = await fetch(`${GAS_URL}?action=complete&user=${encodeURIComponent(user)}&guildId=${id}`);
      const json = await res.json();
      if (json.result === "already_completed") {
        alert("ã“ã®ã‚®ãƒ«ãƒ‰ã¯ã™ã§ã«å®Œäº†æ¸ˆã¿ã§ã™ï¼");
      } else {
        alert(`ã‚®ãƒ«ãƒ‰ã€Œ${name}ã€ã‚’å®Œäº†ï¼ +${point}ãƒã‚¤ãƒ³ãƒˆ`);
      }
      loadGuilds();
    });

    (isComplete ? completeDiv : incompleteDiv).appendChild(div);
  });
}
  const nameInput = document.getElementById("username");
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        login();
      }
    });
</script>

</body>
</html>-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚®ãƒ«ãƒ‰ã‚µã‚¤ãƒˆ</title>
<style>
body {
  font-family: "Hiragino Kaku Gothic ProN", sans-serif;
  background: #f5f5f5;
  text-align: center;
  padding: 20px;
}
.container {
  background: white;
  max-width: 700px;
  margin: auto;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 { border-bottom: 2px solid #4CAF50; padding-bottom: 5px; }
button {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
}
button:hover { background: #388E3C; }
ul { list-style: none; padding: 0; }
li {
  margin: 10px 0;
  padding: 10px;
  background: #e8f5e9;
  border-radius: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸŒŸ ã‚®ãƒ«ãƒ‰ä¸€è¦§ ğŸŒŸ</h1>

  <div>
    <input id="username" value="ä¾‹ï¼šã‚¹ã‚«ã‚¤">
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <h2>æœªå®Œäº†ã‚®ãƒ«ãƒ‰</h2>
  <ul id="available"></ul>

  <h2>å®Œäº†æ¸ˆã¿ã‚®ãƒ«ãƒ‰</h2>
  <ul id="completed"></ul>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwdDrNEY67xq7s8fjb2Nc2BQJonEKARaSbptxOmMNfqDj4JrUSyI69D0ruwQZfqKLGk/exec";

let currentUser = {};

function login() {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");

  currentUser = {
    name: name,
    level: 10,
    loginCount: 1,
    quizCount: 3,
  };

  loadGuilds();
}

function loadGuilds() {
  const payload = {
    mode: "getGuildData",
    user: currentUser
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => renderGuilds(data))
  .catch(err => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err));
}

function renderGuilds(data) {
  const availableList = document.getElementById("available");
  const completedList = document.getElementById("completed");

  availableList.innerHTML = "";
  completedList.innerHTML = "";

  data.available.forEach(g => {
    availableList.innerHTML += `
      <li>
        <b>${g.ã‚¿ã‚¤ãƒˆãƒ«}</b><br>${g.å†…å®¹}<br>
        <small>${g.ãƒã‚¤ãƒ³ãƒˆ}pt</small><br>
        <button onclick="completeGuild('${g.ID}')">å®Œäº†</button>
      </li>`;
  });

  data.completed.forEach(g => {
    completedList.innerHTML += `
      <li>âœ… <b>${g.ã‚¿ã‚¤ãƒˆãƒ«}</b>ï¼ˆ${g.ãƒã‚¤ãƒ³ãƒˆ}ptï¼‰</li>`;
  });
}

function completeGuild(id) {
  const payload = {
    mode: "completeGuild",
    user: currentUser,
    id: id
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(() => {
    alert("ã‚®ãƒ«ãƒ‰å®Œäº†ï¼ãƒã‚¤ãƒ³ãƒˆãŒåŠ ç®—ã•ã‚Œã¾ã—ãŸğŸ‰");
    loadGuilds();
  });
}
  const nameInput = document.getElementById("username");
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        login();
      }
    });
</script>
</body>
</html>
