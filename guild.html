<!--<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ギルド</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #eef5ff;
  margin: 0;
  padding: 20px;
  text-align: center;
}
h1 { color: #284d9e; }
h2 { color: #4a5dbb; margin-top: 25px; }
.guild-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  padding: 12px 15px;
  margin: 10px auto;
  max-width: 350px;
  text-align: left;
}
.guild-card button {
  background: #284d9e;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}
.guild-card button:disabled {
  background: gray;
  cursor: default;
}
</style>
</head>
<body>

<h1> </h1>

<input type="hidden" id="username" placeholder="例：スカイ">
<!--<button onclick="login()">ログイン</button>

<h2>🟢 未完了ギルド</h2>
<div id="guilds-incomplete"></div>

<h2>🟣 完了ギルド</h2>
<div id="guilds-complete"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz8axpmacW0-JGZ0RnCiELFoD3bIXn5xRwPpc-rEbPAtQNKtD7-W22-rWNnrRKK0qjb/exec"; // ←あなたのGAS URLに変更
let user = "";
let completedMap = {};

async function login() {
  user = document.getElementById("username").value.trim();
  if (!user) return alert("名前を入力してください。");
  loadGuilds();
}

async function loadGuilds() {
  const [guilds, personals, completed] = await Promise.all([
    fetch(`${GAS_URL}?action=getGuilds`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getPersonalGuilds&user=${encodeURIComponent(user)}`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getCompleted&user=${encodeURIComponent(user)}`).then(r=>r.json())
  ]);

  completedMap = {};
  completed.forEach(c => completedMap[c[1]] = Number(c[2]));

  displayGuilds([...guilds, ...personals]);
}

function displayGuilds(allGuilds) {
  const incompleteDiv = document.getElementById("guilds-incomplete");
  const completeDiv = document.getElementById("guilds-complete");
  incompleteDiv.innerHTML = "";
  completeDiv.innerHTML = "";

  allGuilds.forEach(g => {
    const [id, , name, desc, point, type] = g;
    const count = completedMap[id] || 0;
    const isComplete = (type === "once" && count > 0);

    const div = document.createElement("div");
    div.className = "guild-card";
    div.innerHTML = `
      <h3>${name}</h3>
      <p>${desc}</p>
      <p>ポイント: ${point} / タイプ: ${type === "once" ? "一人一回まで" : "何回でもOK"}</p>
      ${type === "repeat" ? `<p>完了回数: ${count}</p>` : ""}
      <button ${isComplete ? "disabled" : ""}>＋ ギルド完了</button>
    `;

    div.querySelector("button").addEventListener("click", async () => {
      const res = await fetch(`${GAS_URL}?action=complete&user=${encodeURIComponent(user)}&guildId=${id}`);
      const json = await res.json();
      if (json.result === "already_completed") {
        alert("このギルドはすでに完了済みです！");
      } else {
        alert(`ギルド「${name}」を完了！ +${point}ポイント`);
      }
      loadGuilds();
    });

    (isComplete ? completeDiv : incompleteDiv).appendChild(div);
  });
}
  const nameInput = document.getElementById("username");
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        login();
      }
    });
</script>

</body>
</html>-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ギルドサイト</title>
<style>
body {
  font-family: "Hiragino Kaku Gothic ProN", sans-serif;
  background: #f5f5f5;
  text-align: center;
  padding: 20px;
}
.container {
  background: white;
  max-width: 700px;
  margin: auto;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 { border-bottom: 2px solid #4CAF50; padding-bottom: 5px; }
button {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
}
button:hover { background: #388E3C; }
ul { list-style: none; padding: 0; }
li {
  margin: 10px 0;
  padding: 10px;
  background: #e8f5e9;
  border-radius: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>🌟 ギルド一覧 🌟</h1>

  <div>
    <input id="username" value="例：スカイ">
    <button onclick="login()">ログイン</button>
  </div>

  <h2>未完了ギルド</h2>
  <ul id="available"></ul>

  <h2>完了済みギルド</h2>
  <ul id="completed"></ul>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwdDrNEY67xq7s8fjb2Nc2BQJonEKARaSbptxOmMNfqDj4JrUSyI69D0ruwQZfqKLGk/exec";

let currentUser = {};

function login() {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("名前を入力してください！");

  currentUser = {
    name: name,
    level: 10,
    loginCount: 1,
    quizCount: 3,
  };

  loadGuilds();
}

function loadGuilds() {
  const payload = {
    mode: "getGuildData",
    user: currentUser
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => renderGuilds(data))
  .catch(err => alert("通信エラー: " + err));
}

function renderGuilds(data) {
  const availableList = document.getElementById("available");
  const completedList = document.getElementById("completed");

  availableList.innerHTML = "";
  completedList.innerHTML = "";

  data.available.forEach(g => {
    availableList.innerHTML += `
      <li>
        <b>${g.タイトル}</b><br>${g.内容}<br>
        <small>${g.ポイント}pt</small><br>
        <button onclick="completeGuild('${g.ID}')">完了</button>
      </li>`;
  });

  data.completed.forEach(g => {
    completedList.innerHTML += `
      <li>✅ <b>${g.タイトル}</b>（${g.ポイント}pt）</li>`;
  });
}

function completeGuild(id) {
  const payload = {
    mode: "completeGuild",
    user: currentUser,
    id: id
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(() => {
    alert("ギルド完了！ポイントが加算されました🎉");
    loadGuilds();
  });
}
  const nameInput = document.getElementById("username");
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        login();
      }
    });
</script>
</body>
</html>
