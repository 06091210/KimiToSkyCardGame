<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚®ãƒ«ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #eef5ff;
  margin: 0;
  padding: 20px;
  text-align: center;
}
h1 { color: #284d9e; }
h2 { color: #4a5dbb; margin-top: 25px; }
.guild-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  padding: 12px 15px;
  margin: 10px auto;
  max-width: 350px;
  text-align: left;
}
.guild-card button {
  background: #284d9e;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}
.guild-card button:disabled {
  background: gray;
  cursor: default;
}
</style>
</head>
<body>

<h1>ğŸ° ã‚®ãƒ«ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

<input type="text" id="username" placeholder="ä¾‹ï¼šã‚¹ã‚«ã‚¤">
<button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>

<h2>ğŸŸ¢ æœªå®Œäº†ã‚®ãƒ«ãƒ‰</h2>
<div id="guilds-incomplete"></div>

<h2>ğŸŸ£ å®Œäº†ã‚®ãƒ«ãƒ‰</h2>
<div id="guilds-complete"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz8axpmacW0-JGZ0RnCiELFoD3bIXn5xRwPpc-rEbPAtQNKtD7-W22-rWNnrRKK0qjb/exec"; // â†ã‚ãªãŸã®GAS URLã«å¤‰æ›´
let user = "";
let completedMap = {};

async function login() {
  user = document.getElementById("username").value.trim();
  if (!user) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  loadGuilds();
}

async function loadGuilds() {
  const [guilds, personals, completed] = await Promise.all([
    fetch(`${GAS_URL}?action=getGuilds`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getPersonalGuilds&user=${encodeURIComponent(user)}`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getCompleted&user=${encodeURIComponent(user)}`).then(r=>r.json())
  ]);

  completedMap = {};
  completed.forEach(c => completedMap[c[1]] = Number(c[2]));

  displayGuilds([...guilds, ...personals]);
}

function displayGuilds(allGuilds) {
  const incompleteDiv = document.getElementById("guilds-incomplete");
  const completeDiv = document.getElementById("guilds-complete");
  incompleteDiv.innerHTML = "";
  completeDiv.innerHTML = "";

  allGuilds.forEach(g => {
    const [id, , name, desc, point, type] = g;
    const count = completedMap[id] || 0;
    const isComplete = (type === "once" && count > 0);

    const div = document.createElement("div");
    div.className = "guild-card";
    div.innerHTML = `
      <h3>${name}</h3>
      <p>${desc}</p>
      <p>ãƒã‚¤ãƒ³ãƒˆ: ${point} / ã‚¿ã‚¤ãƒ—: ${type === "once" ? "ä¸€äººä¸€å›ã¾ã§" : "ä½•å›ã§ã‚‚OK"}</p>
      ${type === "repeat" ? `<p>å®Œäº†å›æ•°: ${count}</p>` : ""}
      <button ${isComplete ? "disabled" : ""}>ï¼‹ ã‚®ãƒ«ãƒ‰å®Œäº†</button>
    `;

    div.querySelector("button").addEventListener("click", async () => {
      const res = await fetch(`${GAS_URL}?action=complete&user=${encodeURIComponent(user)}&guildId=${id}`);
      const json = await res.json();
      if (json.result === "already_completed") {
        alert("ã“ã®ã‚®ãƒ«ãƒ‰ã¯ã™ã§ã«å®Œäº†æ¸ˆã¿ã§ã™ï¼");
      } else {
        alert(`ã‚®ãƒ«ãƒ‰ã€Œ${name}ã€ã‚’å®Œäº†ï¼ +${point}ãƒã‚¤ãƒ³ãƒˆ`);
      }
      loadGuilds();
    });

    (isComplete ? completeDiv : incompleteDiv).appendChild(div);
  });
}
  const nameInput = document.getElementById("username");
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        login();
      }
    });
</script>

</body>
</html>
