<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ギルド管理システム</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #eef5ff;
  margin: 0;
  padding: 20px;
  text-align: center;
}
h1 { color: #284d9e; }
h2 { color: #4a5dbb; margin-top: 25px; }
.guild-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  padding: 12px 15px;
  margin: 10px auto;
  max-width: 350px;
  text-align: left;
}
.guild-card button {
  background: #284d9e;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}
.guild-card button:disabled {
  background: gray;
  cursor: default;
}
</style>
</head>
<body>

<h1>🏰 ギルド管理システム</h1>

<input type="text" id="username" placeholder="例：スカイ">
<button onclick="login()">ログイン</button>

<h2>🟢 未完了ギルド</h2>
<div id="guilds-incomplete"></div>

<h2>🟣 完了ギルド</h2>
<div id="guilds-complete"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz8axpmacW0-JGZ0RnCiELFoD3bIXn5xRwPpc-rEbPAtQNKtD7-W22-rWNnrRKK0qjb/exec"; // ←あなたのGAS URLに変更
let user = "";
let completedMap = {};

async function login() {
  user = document.getElementById("username").value.trim();
  if (!user) return alert("名前を入力してください。");
  loadGuilds();
}

async function loadGuilds() {
  const [guilds, personals, completed] = await Promise.all([
    fetch(`${GAS_URL}?action=getGuilds`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getPersonalGuilds&user=${encodeURIComponent(user)}`).then(r=>r.json()),
    fetch(`${GAS_URL}?action=getCompleted&user=${encodeURIComponent(user)}`).then(r=>r.json())
  ]);

  completedMap = {};
  completed.forEach(c => completedMap[c[1]] = Number(c[2]));

  displayGuilds([...guilds, ...personals]);
}

function displayGuilds(allGuilds) {
  const incompleteDiv = document.getElementById("guilds-incomplete");
  const completeDiv = document.getElementById("guilds-complete");
  incompleteDiv.innerHTML = "";
  completeDiv.innerHTML = "";

  allGuilds.forEach(g => {
    const [id, , name, desc, point, type] = g;
    const count = completedMap[id] || 0;
    const isComplete = (type === "once" && count > 0);

    const div = document.createElement("div");
    div.className = "guild-card";
    div.innerHTML = `
      <h3>${name}</h3>
      <p>${desc}</p>
      <p>ポイント: ${point} / タイプ: ${type === "once" ? "一人一回まで" : "何回でもOK"}</p>
      ${type === "repeat" ? `<p>完了回数: ${count}</p>` : ""}
      <button ${isComplete ? "disabled" : ""}>＋ ギルド完了</button>
    `;

    div.querySelector("button").addEventListener("click", async () => {
      const res = await fetch(`${GAS_URL}?action=complete&user=${encodeURIComponent(user)}&guildId=${id}`);
      const json = await res.json();
      if (json.result === "already_completed") {
        alert("このギルドはすでに完了済みです！");
      } else {
        alert(`ギルド「${name}」を完了！ +${point}ポイント`);
      }
      loadGuilds();
    });

    (isComplete ? completeDiv : incompleteDiv).appendChild(div);
  });
}
  const nameInput = document.getElementById("username");
  parent.postMessage({ type: "requestValue" }, "*");
    window.addEventListener("message", (event) => {
      if (event.data.type === "setValue") {
        const name = event.data.value;
        nameInput.value = name;
        login();
      }
    });
</script>

</body>
</html>
