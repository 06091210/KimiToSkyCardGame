<!--<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>送信フォーム</title>
</head>
<body>
  <form id="myForm">
    <input type="text" name="name" placeholder="名前"><br>
    <textarea name="message" placeholder="メッセージ"></textarea><br>
    <button type="submit">送信</button>
  </form>
  <script>
    document.getElementById("myForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      fetch("https://script.google.com/macros/s/AKfycbxCgt8PFPWbCIOJOFbUTG1Dns9jK8Pfp0T6Xu-pLy2lHTGm6ljSIUIvS8gCMv-ydeXC/exec", {
        method: "POST",
        body: data
      })
    });
  </script>
</body>
</html>-->

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テキスト保存・取得（試作）</title
</head>
<body>
  <input type="text" id="Username">
  <button id="auto-login-btn" onclick="copyText(); loadMessages();">LogIn</button>
  <div id="messages">読み込み中...</div>
  <script>
    const loginArea = document.getElementById('login-area');
    const editorArea = document.getElementById('editor-area');
    const usernameInput = document.getElementById('username');
    const loginMsg = document.getElementById('login-msg');
    const textContent = document.getElementById('text-content');
    const saveBtn = document.getElementById('save-btn');
    const saveMsg = document.getElementById('save-msg');
    const output = document.getElementById('output');

    let currentUser = null;
    let updateIntervalId = null;

    function getUsers() {
      const usersJSON = localStorage.getItem('users');
      return usersJSON ? JSON.parse(usersJSON) : {};
    }

    function saveUsers(users) {
      localStorage.setItem('users', JSON.stringify(users));
    }

    function showLogin() {
      loginArea.classList.remove('hidden');
      editorArea.classList.add('hidden');
      loginMsg.textContent = '';
      saveMsg.textContent = '';
      usernameInput.value = '';
    }

    function showEditor() {
      loginArea.classList.add('hidden');
      editorArea.classList.remove('hidden');
      saveMsg.textContent = '';
    }

    function copyText() {
      const text = document.getElementById("Username").value;
      document.getElementById("UserName").value = text;
      document.getElementById("username").value = text;
    }

    const autoLoginBtn = document.getElementById('auto-login-btn');
    autoLoginBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (!username) {
        loginMsg.textContent = 'ユーザー名を入力してください';
        loginMsg.style.color = 'red';
        return;
      }

      const users = getUsers();
      if (users[username]) {
        currentUser = username;
        loginMsg.textContent = 'ログイン成功';
        loginMsg.style.color = 'green';
        textContent.value = users[username].texts || '';
        showEditor();
        startAutoUpdate(); // ← 自動反映開始
      } else {
        users[username] = { texts: '' };
        saveUsers(users);
        currentUser = username;
        loginMsg.textContent = '新規登録完了 & ログインしました';
        loginMsg.style.color = 'green';
        showEditor();
        startAutoUpdate(); // ← 自動反映開始
      }
    });

    saveBtn.addEventListener('click', () => {
      if (!currentUser) return;
      const users = getUsers();
      users[currentUser].texts = textContent.value;
      saveUsers(users);
      saveMsg.textContent = '保存しました！';
      setTimeout(() => saveMsg.textContent = '', 2000);
    });

    function updateOutput() {
      if (!currentUser) return;
      const inputText = textContent.value;
      output.innerHTML = `<h2>${inputText}</h2>`;
    }

    function startAutoUpdate() {
      if (updateIntervalId) clearInterval(updateIntervalId);
      updateIntervalId = setInterval(updateOutput, 3000);
    }

    function loadMessages() {
      const API_URL = "https://api.sheetbest.com/sheets/3a58e982-d42d-4a9e-90a3-9182b5c3c9be";
      fetch(API_URL)
        .then(response => response.json())
        .then(messages => {
          const container = document.getElementById("messages");
          container.innerHTML = "";
          const inputUsername = document.getElementById("Username").value.trim();
          messages.reverse().forEach(msg => {
            if (msg.name === inputUsername) {
              const div = document.createElement("div");
              div.innerHTML = `${msg.KSポイント}`;
              container.appendChild(div);
            }
          });
          if (container.innerHTML === "") {
            container.innerHTML = "一致するユーザーが見つかりませんでした。";
          }
        });
    }

    loadMessages();
    setInterval(loadMessages, 3000);
    showLogin();
  </script>
</body>
</html>
